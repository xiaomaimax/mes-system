# 系统架构文档

## 🏗️ 整体架构

### 架构图
```
┌─────────────────────────────────────────────────────────────┐
│                        用户层 (User Layer)                    │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐   │
│  │  PC端    │  │  平板端  │  │  手机端  │  │  大屏端  │   │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘   │
└─────────────────────────────────────────────────────────────┘
                            ↓ HTTPS
┌─────────────────────────────────────────────────────────────┐
│                      前端层 (Frontend Layer)                  │
│  ┌──────────────────────────────────────────────────────┐  │
│  │              React 18 + Ant Design                    │  │
│  │  ┌────────┐ ┌────────┐ ┌────────┐ ┌────────┐        │  │
│  │  │ 生产   │ │ 质量   │ │ 设备   │ │ 库存   │  ...   │  │
│  │  └────────┘ └────────┘ └────────┘ └────────┘        │  │
│  └──────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
                            ↓ REST API / WebSocket
┌─────────────────────────────────────────────────────────────┐
│                      后端层 (Backend Layer)                   │
│  ┌──────────────────────────────────────────────────────┐  │
│  │              Node.js + Express                        │  │
│  │  ┌────────┐ ┌────────┐ ┌────────┐ ┌────────┐        │  │
│  │  │ API    │ │ 业务   │ │ 数据   │ │ 集成   │        │  │
│  │  │ 网关   │ │ 逻辑   │ │ 访问   │ │ 服务   │        │  │
│  │  └────────┘ └────────┘ └────────┘ └────────┘        │  │
│  └──────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
                            ↓ SQL
┌─────────────────────────────────────────────────────────────┐
│                      数据层 (Data Layer)                      │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐   │
│  │  MySQL   │  │  Redis   │  │  文件    │  │  日志    │   │
│  │  数据库  │  │  缓存    │  │  存储    │  │  存储    │   │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘   │
└─────────────────────────────────────────────────────────────┘
                            ↓ 
┌─────────────────────────────────────────────────────────────┐
│                    集成层 (Integration Layer)                 │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐   │
│  │  ERP     │  │  WMS     │  │  设备    │  │  第三方  │   │
│  │  系统    │  │  系统    │  │  数采    │  │  系统    │   │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘   │
└─────────────────────────────────────────────────────────────┘
```

## 📦 模块架构

### 核心模块
```
mes-system/
├── client/                    # 前端应用
│   ├── public/               # 静态资源
│   └── src/
│       ├── components/       # React组件
│       │   ├── production/  # 生产管理
│       │   ├── quality/     # 质量管理
│       │   ├── equipment/   # 设备管理
│       │   ├── inventory/   # 库存管理
│       │   ├── process/     # 工艺管理
│       │   ├── personnel/   # 人员管理
│       │   ├── integration/ # 系统集成
│       │   ├── settings/    # 系统设置
│       │   └── common/      # 公共组件
│       ├── services/        # API服务
│       ├── utils/           # 工具函数
│       ├── hooks/           # 自定义Hooks
│       ├── contexts/        # Context上下文
│       └── App.js           # 应用入口
│
├── server/                   # 后端应用
│   ├── controllers/         # 控制器
│   ├── models/              # 数据模型
│   ├── routes/              # 路由定义
│   ├── services/            # 业务服务
│   ├── middleware/          # 中间件
│   ├── utils/               # 工具函数
│   └── app.js               # 服务入口
│
├── database/                 # 数据库
│   ├── init.sql            # 初始化脚本
│   ├── migrations/         # 数据迁移
│   └── seeds/              # 测试数据
│
├── docs/                     # 文档
├── scripts/                  # 脚本工具
└── tests/                    # 测试用例
```

## 🔄 数据流架构

### 请求处理流程
```
用户操作
    ↓
前端组件 (React Component)
    ↓
API服务 (API Service)
    ↓
HTTP请求 (Axios)
    ↓
后端路由 (Express Router)
    ↓
中间件 (Middleware)
    ├── 身份验证 (Authentication)
    ├── 权限检查 (Authorization)
    └── 数据验证 (Validation)
    ↓
控制器 (Controller)
    ↓
业务服务 (Service)
    ↓
数据模型 (Model)
    ↓
数据库 (MySQL)
    ↓
响应数据
    ↓
前端更新 (State Update)
    ↓
UI渲染 (Re-render)
```

### 实时数据流
```
设备/传感器
    ↓
数据采集服务
    ↓
消息队列 (Message Queue)
    ↓
数据处理服务
    ↓
WebSocket服务器
    ↓
前端WebSocket客户端
    ↓
实时UI更新
```

## 🗄️ 数据库设计

### 核心表结构
```sql
-- 用户表
users
├── id (主键)
├── username (用户名)
├── password (密码)
├── role_id (角色ID)
├── department_id (部门ID)
└── status (状态)

-- 生产订单表
production_orders
├── id (主键)
├── order_no (订单号)
├── product_id (产品ID)
├── quantity (数量)
├── status (状态)
└── created_at (创建时间)

-- 质量检验表
quality_inspections
├── id (主键)
├── order_id (订单ID)
├── type (检验类型)
├── result (检验结果)
└── inspector_id (检验员ID)

-- 设备表
equipment
├── id (主键)
├── code (设备编号)
├── name (设备名称)
├── status (运行状态)
└── location (位置)

-- 库存表
inventory
├── id (主键)
├── material_id (物料ID)
├── quantity (数量)
├── warehouse_id (仓库ID)
└── updated_at (更新时间)
```

## 🔐 安全架构

### 安全层次
```
┌─────────────────────────────────────┐
│  网络安全层                          │
│  - HTTPS加密                        │
│  - 防火墙配置                       │
│  - DDoS防护                         │
└─────────────────────────────────────┘
            ↓
┌─────────────────────────────────────┐
│  应用安全层                          │
│  - JWT身份认证                      │
│  - RBAC权限控制                     │
│  - API限流                          │
│  - XSS/CSRF防护                     │
└─────────────────────────────────────┘
            ↓
┌─────────────────────────────────────┐
│  数据安全层                          │
│  - 数据加密存储                     │
│  - SQL注入防护                      │
│  - 敏感数据脱敏                     │
│  - 数据备份恢复                     │
└─────────────────────────────────────┘
            ↓
┌─────────────────────────────────────┐
│  审计安全层                          │
│  - 操作日志记录                     │
│  - 异常行为监控                     │
│  - 安全事件告警                     │
│  - 合规性审计                       │
└─────────────────────────────────────┘
```

## 🚀 性能优化

### 前端优化
- **代码分割**: React.lazy + Suspense
- **路由懒加载**: 按需加载组件
- **图片优化**: WebP格式 + 懒加载
- **缓存策略**: Service Worker + LocalStorage
- **打包优化**: Tree Shaking + 代码压缩

### 后端优化
- **数据库优化**: 索引优化 + 查询优化
- **缓存策略**: Redis缓存热点数据
- **连接池**: 数据库连接池管理
- **异步处理**: 消息队列处理耗时任务
- **负载均衡**: Nginx反向代理

### 网络优化
- **CDN加速**: 静态资源CDN分发
- **Gzip压缩**: 响应数据压缩
- **HTTP/2**: 多路复用
- **DNS预解析**: 减少DNS查询时间

## 📊 监控架构

### 监控体系
```
应用监控
├── 性能监控
│   ├── 响应时间
│   ├── 吞吐量
│   └── 错误率
├── 业务监控
│   ├── 订单量
│   ├── 用户活跃度
│   └── 功能使用率
└── 资源监控
    ├── CPU使用率
    ├── 内存使用率
    └── 磁盘IO

日志系统
├── 应用日志
├── 访问日志
├── 错误日志
└── 审计日志

告警系统
├── 邮件告警
├── 短信告警
├── 企业微信告警
└── 钉钉告警
```

## 🔄 部署架构

### 生产环境部署
```
┌─────────────────────────────────────┐
│  负载均衡 (Nginx)                    │
└─────────────────────────────────────┘
            ↓
┌─────────────────────────────────────┐
│  应用服务器集群                      │
│  ┌──────┐  ┌──────┐  ┌──────┐      │
│  │ App1 │  │ App2 │  │ App3 │      │
│  └──────┘  └──────┘  └──────┘      │
└─────────────────────────────────────┘
            ↓
┌─────────────────────────────────────┐
│  数据库集群                          │
│  ┌──────────┐  ┌──────────┐        │
│  │  Master  │  │  Slave   │        │
│  └──────────┘  └──────────┘        │
└─────────────────────────────────────┘
```

### 容器化部署
```
Docker Compose
├── mes-app (应用容器)
├── mysql (数据库容器)
├── redis (缓存容器)
├── nginx (反向代理容器)
└── monitor (监控容器)
```

## 🔧 技术栈详情

### 前端技术栈
- **框架**: React 18.2.0
- **UI库**: Ant Design 5.x
- **路由**: React Router 6.x
- **状态管理**: React Context + Hooks
- **HTTP客户端**: Axios
- **图表库**: Recharts
- **构建工具**: Create React App

### 后端技术栈
- **运行环境**: Node.js 16+
- **Web框架**: Express 4.x
- **数据库**: MySQL 8.0
- **ORM**: Sequelize
- **认证**: JWT + bcrypt
- **日志**: Winston
- **进程管理**: PM2

### 开发工具
- **版本控制**: Git
- **代码规范**: ESLint + Prettier
- **测试框架**: Jest + React Testing Library
- **API文档**: Swagger
- **容器化**: Docker + Docker Compose

---

**更新时间**: 2024-12-22  
**文档版本**: v1.0.0